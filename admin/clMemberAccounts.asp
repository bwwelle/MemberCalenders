<!-- #include file ="clmail.asp" --><!-- #include file ="clforum.asp" --><%Function GetMembers(sortby,sortorder)	Dim rsMembers	Dim sSQL	Dim conn		set conn = server.CreateObject("ADODB.Connection")	conn.Open(dicConnections("customcal"))		set rsMembers = server.CreateObject("ADODB.Recordset")		if sortby = "" then		sortby = "ORDER BY Last_Name " & sortorder	elseif sortby = "forumname" then		sortby = "ORDER BY Forum_UserName " & sortorder	elseif sortby = "username" then		sortby = "ORDER BY User " & sortorder	end if		sSQL = "SELECT id, User, Password, Forum_UserName, First_Name, Last_Name, " & _		   "address, city, state, zip, country, phone1, phone2, fax, email, Bio, " & _		   "IP_Address, URL, Join_Date, Active, [notes] " & _		   "FROM Members " & sortby	rsMembers.Open sSQL, conn		set GetMembers = rsMembers	End FunctionFunction GetMember(mid)	Dim rsMember	Dim rsMemberheader	Dim sSQL	Dim conn		set conn = server.CreateObject("ADODB.Connection")	conn.Open(dicConnections("customcal"))		set rsMember = server.CreateObject("ADODB.Recordset")			sSQL = "SELECT id, User, Password, Forum_UserName, First_Name, Last_Name, " & _		   "address, city, state, zip, country, phone1, phone2, fax, email, Bio, " & _		   "IP_Address, URL, Join_Date, Active, [notes] " & _		   "FROM Members " & _		   "WHERE id = @mid"	Dim oCmd	set oCmd = Server.CreateObject("ADODB.Command")		with oCmd		.ActiveConnection = conn    	.CommandText = sSQL    	.CommandType = adCmdText    	.Parameters.Append .CreateParameter("@mid", adInteger, adParamInput, 4, mid)	end with		rsMember.Open oCmd		set GetMember = rsMember	End FunctionFunction GetMemberCredentials(Email)	Dim rsMember	Dim sSQL	Dim conn		set conn = server.CreateObject("ADODB.Connection")	conn.Open(dicConnections("customcal"))		set rsMember = server.CreateObject("ADODB.Recordset")			sSQL = "SELECT ID, User as username, Password " & _		   "FROM Members " & _		   "WHERE email = @email_address"	Dim oCmd	set oCmd = Server.CreateObject("ADODB.Command")		with oCmd		.ActiveConnection = conn    	.CommandText = sSQL    	.CommandType = adCmdText    	.Parameters.Append .CreateParameter("@email_address", adVarChar, adParamInput, len(Email), Email)	end with		rsMember.Open oCmd		set GetMemberCredentials = rsMember	End FunctionFunction GetMemberForums(MemberID)	Dim rsMemberForums	Dim sSQL	Dim conn		set conn = server.CreateObject("ADODB.Connection")	conn.Open(dicConnections("customcal"))		set rsMemberForums = server.CreateObject("ADODB.Recordset")			sSQL = "SELECT ForumName " & _		   "FROM MemberForums " & _		   "WHERE MemberID = @MemberID"	Dim oCmd	set oCmd = Server.CreateObject("ADODB.Command")		with oCmd		.ActiveConnection = conn    	.CommandText = sSQL    	.CommandType = adCmdText    	.Parameters.Append .CreateParameter("@MemberID", adInteger, adParamInput, 4, MemberID)	end with		rsMemberForums.Open oCmd		set GetMemberForums = rsMemberForums	End FunctionFunction VerifyMemberUserName(sUsername)	Dim rsVerifyMemberUsername	Dim sSQL	Dim conn		set conn = server.CreateObject("ADODB.Connection")	conn.Open(dicConnections("customcal"))		set rsVerifyMemberUsername = server.CreateObject("ADODB.Recordset")			sSQL = "SELECT count(1) as username_count " & _		   "FROM Members " & _		   "WHERE user = @username"	Dim oCmd	set oCmd = Server.CreateObject("ADODB.Command")		with oCmd		.ActiveConnection = conn    	.CommandText = sSQL    	.CommandType = adCmdText    	.Parameters.Append .CreateParameter("@username", adVarChar, adParamInput, Len(sUserName), sUserName)	end with		rsVerifyMemberUsername.Open oCmd		VerifyMemberUserName = rsVerifyMemberUsername("username_count")	End FunctionFunction VerifyMemberEmail(EmailAddress)	Dim rsVerifyMemberEmail	Dim sSQL	Dim conn		set conn = server.CreateObject("ADODB.Connection")	conn.Open(dicConnections("customcal"))		set rsVerifyMemberEmail = server.CreateObject("ADODB.Recordset")			sSQL = "SELECT count(1) as email_count " & _		   "FROM Members " & _		   "WHERE email = @email"	Dim oCmd	set oCmd = Server.CreateObject("ADODB.Command")		with oCmd		.ActiveConnection = conn    	.CommandText = sSQL    	.CommandType = adCmdText    	.Parameters.Append .CreateParameter("@email", adVarChar, adParamInput, Len(EmailAddress), EmailAddress)	end with		rsVerifyMemberEmail.Open oCmd		VerifyMemberEmail = rsVerifyMemberEmail("email_count")	End FunctionFunction GetProductsForMember(memberID)	Dim rsGetProductsForMember	Dim sSQL	Dim conn		set conn = server.CreateObject("ADODB.Connection")	conn.Open(dicConnections("customcal"))		set rsGetProductsForMember = server.CreateObject("ADODB.Recordset")		sSQL = "SELECT Products.id as product_id, Products.Product_Name, Products.Price, " & _	   	   "Products.ThumbNailPath, Products.ImagePath, Vote_Schedule.Cut_off_Date, Vote_Schedule.Round_3_Completed, " & _		   "Members.id, Products.Thumbnail, Forums.Name " & _		   "FROM (((Members INNER JOIN MemberForums ON Members.id = MemberForums.MemberID) " & _		   "INNER JOIN Forums ON MemberForums.ForumName = Forums.Name) " & _		   "INNER JOIN Products ON Forums.id = Products.Forum_Id) " & _		   "INNER JOIN Vote_Schedule ON Products.SKU = Vote_Schedule.SKU " & _		   "WHERE (((Members.id) = " & MemberID & ")) " & _		   "AND ((Vote_Schedule.Round_3_Completed) is null) " & _		   "AND Products.Active = true"	rsGetProductsForMember.Open sSQL, conn, adOpenStatic, adLockReadOnly	set GetProductsForMember = rsGetProductsForMember	End FunctionSub AddMemberAccount( ForumNames, User, Password, Forum_UserName, First_Name, Last_Name, _			   		  Address, City, sState, Zip, Country, Phone1, Phone2, Fax, Email, Bio, _			   		  IpAddress, URL, Active, sNotes, sFrom )	Dim sSQL	Dim conn	Dim iReturnVal		set conn = server.CreateObject("ADODB.Connection")	conn.Open(dicConnections("customcal"))		Dim JoinDate		JoinDate = CurrentTime		sSQL = "INSERT INTO Members([User], [Password], [Forum_UserName], [First_Name], " & _		   "[Last_Name], [Address], [City], [State], [Zip], [Country], [Phone1], [Phone2], " & _		   "[Fax], [Email], [Bio], [IP_Address], [URL], [Join_Date], [Active], [Notes] ) " & _		   "VALUES( @UserName, @Password, @ForumUserName, @FirstName, @LastName, " & _		   "@Address, @City, @State, @Zipcode, @Country, @Phone1, @Phone2, @Fax, " & _		   "@EmailAddress, @Bio, @IpAddress, @Url, @JoinDate, @IsActive, @sNotes)" 	Dim oCmd	set oCmd = Server.CreateObject("ADODB.Command")	with oCmd                                                      		.ActiveConnection = conn    	.CommandText = sSQL    	.CommandType = adCmdText    	.Parameters.Append .CreateParameter("@UserName", adVarChar, adParamInput, Len(User), User)    	.Parameters.Append .CreateParameter("@Password", adVarChar, adParamInput, Len(Password), Password)		if Len(Forum_UserName) = 0 then	    	.Parameters.Append .CreateParameter("@ForumUserName", adVarChar, adParamInput, 1, null)		else	    	.Parameters.Append .CreateParameter("@ForumUserName", adVarChar, adParamInput, Len(Forum_UserName), Forum_UserName)		end if    	.Parameters.Append .CreateParameter("@FirstName", adVarChar, adParamInput, Len(First_Name), First_Name)    	.Parameters.Append .CreateParameter("@LastName", adVarChar, adParamInput, Len(Last_Name), Last_Name)    	.Parameters.Append .CreateParameter("@Address", adVarChar, adParamInput, Len(Address), Address)    	.Parameters.Append .CreateParameter("@City", adVarChar, adParamInput, Len(City), City)	   	.Parameters.Append .CreateParameter("@State", adVarChar, adParamInput, Len(sState), sState)    	.Parameters.Append .CreateParameter("@Zipcode", adVarChar, adParamInput, Len(Zip), Zip)    	.Parameters.Append .CreateParameter("@Country", adVarChar, adParamInput, Len(Country), Country)    	.Parameters.Append .CreateParameter("@Phone1", adVarChar, adParamInput, Len(Phone1), Phone1)		if Len(Phone2) = 0 then	    	.Parameters.Append .CreateParameter("@Phone2", adVarChar, adParamInput, 1, null)		else	    	.Parameters.Append .CreateParameter("@Phone2", adVarChar, adParamInput, Len(Phone2), Phone2)		end if		if Len(Fax) = 0 then    		.Parameters.Append .CreateParameter("@Fax", adVarChar, adParamInput, 1, null)		else    		.Parameters.Append .CreateParameter("@Fax", adVarChar, adParamInput, Len(Fax), Fax)		end if    	.Parameters.Append .CreateParameter("@EmailAddress", adVarChar, adParamInput, Len(Email), Email)		if Len(Bio) = 0 then	    	.Parameters.Append .CreateParameter("@Bio", adVarChar, adParamInput, 1, null)		else	    	.Parameters.Append .CreateParameter("@Bio", adVarChar, adParamInput, Len(Bio), Bio)		end if		if Len(IpAddress) = 0 then	    	.Parameters.Append .CreateParameter("@IpAddress", adVarChar, adParamInput, 1, null)		else	    	.Parameters.Append .CreateParameter("@IpAddress", adVarChar, adParamInput, Len(IpAddress), IpAddress)		end if		if Len(URL) = 0 then	    	.Parameters.Append .CreateParameter("@URL", adVarChar, adParamInput, 1, null)		else	    	.Parameters.Append .CreateParameter("@URL", adVarChar, adParamInput, Len(URL), URL)		end if    	.Parameters.Append .CreateParameter("@JoinDate", adDBTimeStamp, adParamInput, 16, JoinDate)    	.Parameters.Append .CreateParameter("@IsActive", adBoolean, adParamInput, 4, Active)		if Len(sNotes) = 0 then	    	.Parameters.Append .CreateParameter("@sNotes", adLongVarChar, adParamInput, 1, null)		else	    	.Parameters.Append .CreateParameter("@sNotes", adLongVarChar, adParamInput, Len(sNotes) , sNotes)		end if				.execute	end with	Dim rs	sSQL = "SELECT max(id) as iMemberID FROM Members"	with oCmd                                                      		.ActiveConnection = conn   		.CommandText = sSQL    	.CommandType = adCmdText				rs = .execute	End With			'Dim	aForums	'Dim Found	Dim iMemberID	Dim rsForums		iMemberID = rs("iMemberID")	set rsForums = GetForums()	'Found = 0	'aForums = Split(ForumNames,",")	'for each x in aForums	while not rsForums.eof		sSQL = "INSERT INTO MemberForums([MemberID], [ForumName]) " & _			   "VALUES( @MemberID, @ForumName)"		Do While (oCmd.Parameters.Count > 0)        	oCmd.Parameters.Delete 0	    Loop				with oCmd                                                      			.ActiveConnection = conn    		.CommandText = sSQL	    	.CommandType = adCmdText		    	.Parameters.Append .CreateParameter("@MemberID", adInteger, adParamInput, 4, iMemberID)	    	.Parameters.Append .CreateParameter("@ForumName", adVarChar, adParamInput, Len(trim(rsForums("Name"))), trim(rsForums("Name")))			.execute		End With		rsForums.MoveNext	wend	'next	conn.Close()		clEmail_NewUserRegistration User, Email			if sFrom = "" then		response.Redirect("MemberAccounts.asp")	elseif sFrom = "Import" then		response.Redirect("ImportExportData.asp")	else		response.Redirect("../confirmation.asp?section=member")		'response.Redirect("../myaccount.asp")	end if		End SubSub UpdateMemberAccount( MemberID, sForums, User, Password, Forum_UserName, First_Name, Last_Name, _				   		 Address, City, sState, Zip, Country, Phone1, Phone2, Fax, Email, Bio, _				   	     IpAddress, URL, JoinDate, Active, sNotes, sFrom )	Dim sSQL	Dim conn		set conn = server.CreateObject("ADODB.Connection")	conn.Open(dicConnections("customcal"))		sSQL = "UPDATE Members " & _		   "SET [User] = @UserName, " & _		   "[Password] = @Password, " & _		   "[Forum_Username] = @ForumUserName, " & _		   "[First_Name] = @FirstName, " & _		   "[Last_Name] = @LastName, " & _		   "[Address] = @Address, " & _		   "[City] = @City, " & _		   "[State] = @State, " & _		   "[Zip] = @Zipcode, " & _		   "[Country] = @Country, " & _		   "[Phone1] = @Phone1, " & _		   "[Phone2] = @Phone2, " & _		   "[Fax] = @Fax, " & _		   "[Email] = @EmailAddress, " & _		   "[Bio] = @Bio, " & _		   "[IP_Address] = @IpAddress, " & _		   "[URL] = @URL, " & _		   "[Active] = @IsActive, " & _		   "[Notes] = @sNotes " & _		   "WHERE id = @MemberID"	Dim oCmd	set oCmd = Server.CreateObject("ADODB.Command")	with oCmd                                                      		.ActiveConnection = conn    	.CommandText = sSQL    	.CommandType = adCmdText    	.Parameters.Append .CreateParameter("@UserName", adVarChar, adParamInput, Len(User), User)    	.Parameters.Append .CreateParameter("@Password", adVarChar, adParamInput, Len(Password), Password)		if Len(Forum_UserName) = 0 then	    	.Parameters.Append .CreateParameter("@ForumUserName", adVarChar, adParamInput, 1, null)		else	    	.Parameters.Append .CreateParameter("@ForumUserName", adVarChar, adParamInput, Len(Forum_UserName), Forum_UserName)		end if    	.Parameters.Append .CreateParameter("@FirstName", adVarChar, adParamInput, Len(First_Name), First_Name)    	.Parameters.Append .CreateParameter("@LastName", adVarChar, adParamInput, Len(Last_Name), Last_Name)    	.Parameters.Append .CreateParameter("@Address", adVarChar, adParamInput, Len(Address), Address)    	.Parameters.Append .CreateParameter("@City", adVarChar, adParamInput, Len(City), City)	   	.Parameters.Append .CreateParameter("@State", adVarChar, adParamInput, Len(sState), sState)    	.Parameters.Append .CreateParameter("@Zipcode", adVarChar, adParamInput, Len(Zip), Zip)    	.Parameters.Append .CreateParameter("@Country", adVarChar, adParamInput, Len(Country), Country)    	.Parameters.Append .CreateParameter("@Phone1", adVarChar, adParamInput, Len(Phone1), Phone1)		if Len(Phone2) = 0 then	    	.Parameters.Append .CreateParameter("@Phone2", adVarChar, adParamInput, 1, null)		else	    	.Parameters.Append .CreateParameter("@Phone2", adVarChar, adParamInput, Len(Phone2), Phone2)		end if		if Len(Fax) = 0 then    		.Parameters.Append .CreateParameter("@Fax", adVarChar, adParamInput, 1, null)		else    		.Parameters.Append .CreateParameter("@Fax", adVarChar, adParamInput, Len(Fax), Fax)		end if    	.Parameters.Append .CreateParameter("@EmailAddress", adVarChar, adParamInput, Len(Email), Email)		if Len(Bio) = 0 then	    	.Parameters.Append .CreateParameter("@Bio", adVarChar, adParamInput, 1, null)		else	    	.Parameters.Append .CreateParameter("@Bio", adVarChar, adParamInput, Len(Bio), Bio)		end if		if Len(IpAddress) = 0 then	    	.Parameters.Append .CreateParameter("@IpAddress", adVarChar, adParamInput, 1, null)		else	    	.Parameters.Append .CreateParameter("@IpAddress", adVarChar, adParamInput, Len(IpAddress), IpAddress)		end if		if Len(URL) = 0 then	    	.Parameters.Append .CreateParameter("@URL", adVarChar, adParamInput, 1, null)		else	    	.Parameters.Append .CreateParameter("@URL", adVarChar, adParamInput, Len(URL), URL)		end if    	.Parameters.Append .CreateParameter("@IsActive", adBoolean, adParamInput, 4, Active)		if Len(sNotes) = 0 then	    	.Parameters.Append .CreateParameter("@sNotes", adLongVarChar, adParamInput, 1, null)		else	    	.Parameters.Append .CreateParameter("@sNotes", adLongVarChar, adParamInput, Len(sNotes) , sNotes)		end if    	.Parameters.Append .CreateParameter("@MemberID", adInteger, adParamInput, 4, MemberID)	end with	oCmd.execute	'	Dim	aForums'	Dim Found'	Do While (oCmd.Parameters.Count > 0) '      	oCmd.Parameters.Delete 0'    Loop'	if sFrom = "" then'		sSQL = "DELETE FROM MemberForums WHERE MemberID = @MemberID"'		with oCmd                                                      '			.ActiveConnection = conn'			.CommandText = sSQL'			.CommandType = adCmdText		'			.Parameters.Append .CreateParameter("@MemberID", adInteger, adParamInput, 4, MemberID)'	'			.execute'		End With'	'		aForums = Split(sForums,",")	'		for each x in aForums'			sSQL = "INSERT INTO MemberForums([MemberID], [ForumName]) " & _'				   "VALUES( @MemberID, @ForumName)"'	'			Do While (oCmd.Parameters.Count > 0)'				oCmd.Parameters.Delete 0'			Loop'			'			with oCmd                                                      '				.ActiveConnection = conn'				.CommandText = sSQL'				.CommandType = adCmdText'		'				.Parameters.Append .CreateParameter("@MemberID", adInteger, adParamInput, 4, MemberID)'				.Parameters.Append .CreateParameter("@ForumName", adVarChar, adParamInput, Len(trim(x)), trim(x))'	'				.execute'			End With'		next	'	end if	conn.Close()		if sFrom = "" then		response.Redirect("MemberAccounts.asp")	else		response.Redirect("../editaccount.asp")	end if	End SubSub ActivateMember(MemberID)	Dim sSQL	Dim conn	set conn = server.CreateObject("ADODB.Connection")	conn.Open(dicConnections("customcal"))	Dim oCmd	set oCmd = Server.CreateObject("ADODB.Command")		sSQL = "UPDATE Members " & _		   "SET Active = true " & _		   "WHERE id = @MemberID"	with oCmd		.ActiveConnection = conn    	.CommandText = sSQL    	.CommandType = adCmdText    	.Parameters.Append .CreateParameter("@MemberID", adInteger, adParamInput, 4, MemberID)	end with		oCmd.execute()End SubSub DeleteMemberAccount( MemberID, sFrom )	Dim sSQL	Dim conn	set conn = server.CreateObject("ADODB.Connection")	conn.Open(dicConnections("customcal"))	Dim oCmd	set oCmd = Server.CreateObject("ADODB.Command")		sSQL = "DELETE FROM MemberForums WHERE MemberID = @MemberID"	with oCmd                                                      		.ActiveConnection = conn		.CommandText = sSQL		.CommandType = adCmdText			.Parameters.Append .CreateParameter("@MemberID", adInteger, adParamInput, 4, MemberID)			.execute	End With	Do While (oCmd.Parameters.Count > 0)       	oCmd.Parameters.Delete 0    Loop		sSQL = "DELETE FROM Members " & _		   "WHERE id = @MemberID"	with oCmd		.ActiveConnection = conn    	.CommandText = sSQL    	.CommandType = adCmdText    	.Parameters.Append .CreateParameter("@MemberID", adInteger, adParamInput, 4, MemberID)	end with		oCmd.execute()			if sFrom = "" then		response.Redirect("MemberAccounts.asp")	else		response.Redirect("../confirmation.asp?section=member")	end if	End Sub%>